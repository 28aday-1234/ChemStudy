<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemStudy - Quiz History</title>
    <link rel="stylesheet" href="history-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo" style="text-decoration: none;">
                <span class="logo-icon">‚öóÔ∏è</span>
                <span class="logo-text">ChemStudy</span>
            </a>
            <div class="nav-links">
                <span id="welcomeUser"></span>
                <a href="quiz.html">Take Quiz</a>
                <a href="leaderboard.html">Leaderboard</a>
                <a href="#" onclick="logout(); return false;" style="color: #ef4444;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="page-header">
            <h1>üìä Your Quiz History</h1>
            <p>Track your progress and see how you've improved over time</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-content">
                    <div class="stat-value" id="totalQuizzes">0</div>
                    <div class="stat-label">Quizzes Taken</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-content">
                    <div class="stat-value" id="averageScore">0%</div>
                    <div class="stat-label">Average Score</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-content">
                    <div class="stat-value" id="totalPoints">0</div>
                    <div class="stat-label">Total Points</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-content">
                    <div class="stat-value" id="bestScore">0%</div>
                    <div class="stat-label">Best Score</div>
                </div>
            </div>
        </div>

        <!-- History List -->
        <div class="history-container">
            <h2>Recent Quizzes</h2>
            <div id="historyList" class="history-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading your history...</p>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state hidden">
            <div class="empty-icon">üìö</div>
            <h3>No Quiz History Yet</h3>
            <p>Take your first quiz to start tracking your progress!</p>
            <a href="quiz.html" class="btn btn-primary">Take Your First Quiz</a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let currentUser = null;

        // Check if user is logged in
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                currentUser = user;
                const displayName = user.email.split('@')[0];
                document.getElementById('welcomeUser').textContent = `üë§ ${displayName}`;
                loadQuizHistory();
            }
        });

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        }

        function loadQuizHistory() {
            if (!currentUser) return;

            const historyList = document.getElementById('historyList');
            const emptyState = document.getElementById('emptyState');

            db.collection('quizHistory')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        historyList.style.display = 'none';
                        emptyState.classList.remove('hidden');
                        return;
                    }

                    let totalQuizzes = 0;
                    let totalScore = 0;
                    let totalQuestions = 0;
                    let bestScore = 0;
                    const quizzes = [];

                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        totalQuizzes++;
                        totalScore += data.score || 0;
                        totalQuestions += data.totalQuestions || 0;
                        bestScore = Math.max(bestScore, data.percentage || 0);
                        quizzes.push(data);
                    });

                    // Sort by timestamp (most recent first)
                    quizzes.sort((a, b) => {
                        const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                        const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                        return timeB - timeA; // Descending order
                    });

                    // Update statistics
                    const averageScore = totalQuestions > 0 ? Math.round((totalScore / totalQuestions) * 100) : 0;
                    
                    document.getElementById('totalQuizzes').textContent = totalQuizzes;
                    document.getElementById('averageScore').textContent = averageScore + '%';
                    document.getElementById('totalPoints').textContent = totalScore;
                    document.getElementById('bestScore').textContent = bestScore + '%';

                    // Display quiz history
                    historyList.innerHTML = '';
                    quizzes.forEach((quiz) => {
                        const item = createHistoryItem(quiz);
                        historyList.appendChild(item);
                    });
                })
                .catch((error) => {
                    console.error('Error loading quiz history:', error);
                    historyList.innerHTML = '<div class="error">Error loading history. Please try again.</div>';
                });
        }

        function createHistoryItem(quiz) {
            const item = document.createElement('div');
            item.className = 'history-item';
            
            const percentage = quiz.percentage || 0;
            const scoreClass = percentage >= 80 ? 'excellent' : percentage >= 60 ? 'good' : 'needs-improvement';
            
            const date = quiz.timestamp ? formatDate(quiz.timestamp.toDate()) : 'Recently';
            
            item.innerHTML = `
                <div class="history-item-header">
                    <div class="history-topic">
                        <span class="topic-icon">‚öõÔ∏è</span>
                        <span class="topic-name">${quiz.topic}</span>
                    </div>
                    <div class="history-date">${date}</div>
                </div>
                <div class="history-item-body">
                    <div class="score-badge ${scoreClass}">${percentage}%</div>
                    <div class="score-details">
                        <span>${quiz.score} / ${quiz.totalQuestions} correct</span>
                    </div>
                </div>
            `;
            
            return item;
        }

        function formatDate(date) {
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
    </script>
</body>
</html>

