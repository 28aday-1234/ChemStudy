<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemStudy - Leaderboard</title>
    <link rel="stylesheet" href="leaderboard-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo" style="text-decoration: none;">
                <span class="logo-icon">‚öóÔ∏è</span>
                <span class="logo-text">ChemStudy</span>
            </a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="quiz.html">Take Quiz</a>
                <a href="history.html">History</a>
                <span id="userDisplay"></span>
                <a href="#" id="authLink" onclick="handleAuth(); return false;">Login</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="leaderboard-header">
            <div class="header-content">
                <h1>üèÜ Global Leaderboard</h1>
                <p>Compete with chemistry students from around the world</p>
            </div>
            <div class="filter-controls">
                <button class="filter-btn active" onclick="filterLeaderboard('all')">All Time</button>
                <button class="filter-btn" onclick="filterLeaderboard('week')">This Week</button>
                <button class="filter-btn" onclick="filterLeaderboard('month')">This Month</button>
            </div>
        </div>

        <!-- Your Rank Card (for logged-in users) -->
        <div id="yourRankCard" class="your-rank-card hidden">
            <div class="rank-badge">Your Rank</div>
            <div class="rank-details">
                <div class="rank-number">#<span id="yourRank">-</span></div>
                <div class="rank-stats">
                    <div class="stat-item">
                        <span class="stat-label">Average Score</span>
                        <span class="stat-value" id="yourAverage">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Quizzes Taken</span>
                        <span class="stat-value" id="yourQuizzes">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Score</span>
                        <span class="stat-value" id="yourTotal">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Table -->
        <div class="leaderboard-container">
            <div class="leaderboard-table">
                <div class="table-header">
                    <div class="col-rank">Rank</div>
                    <div class="col-user">Student</div>
                    <div class="col-score">Avg Score</div>
                    <div class="col-quizzes">Quizzes</div>
                    <div class="col-total">Total Points</div>
                </div>
                <div id="leaderboardBody" class="table-body">
                    <!-- Loading state -->
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading leaderboard...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state hidden">
            <div class="empty-icon">üìä</div>
            <h2>No Data Yet</h2>
            <p>Be the first to take a quiz and appear on the leaderboard!</p>
            <a href="quiz.html" class="btn btn-primary">Take Your First Quiz</a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let currentUser = null;
        let currentFilter = 'all';

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            updateAuthUI(user);
            loadLeaderboard();
        });

        function updateAuthUI(user) {
            const userDisplay = document.getElementById('userDisplay');
            const authLink = document.getElementById('authLink');
            
            if (user) {
                const displayName = user.email.split('@')[0];
                userDisplay.textContent = `üë§ ${displayName}`;
                userDisplay.style.display = 'inline';
                authLink.textContent = 'Logout';
                authLink.style.color = '#ef4444';
            } else {
                userDisplay.style.display = 'none';
                authLink.textContent = 'Login';
                authLink.style.color = '';
            }
        }

        function handleAuth() {
            if (currentUser) {
                auth.signOut().then(() => {
                    window.location.reload();
                });
            } else {
                window.location.href = 'login.html';
            }
        }

        function loadLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboardBody');
            const emptyState = document.getElementById('emptyState');
            
            db.collection('leaderboard')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        leaderboardBody.innerHTML = '';
                        emptyState.classList.remove('hidden');
                        return;
                    }

                    // Collect all data and sort in JavaScript
                    const leaderboardData = [];
                    querySnapshot.forEach((doc) => {
                        leaderboardData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    // Sort by average score (desc), then by total score (desc)
                    leaderboardData.sort((a, b) => {
                        if (b.averageScore !== a.averageScore) {
                            return b.averageScore - a.averageScore;
                        }
                        return b.totalScore - a.totalScore;
                    });

                    // Limit to top 100
                    const topPlayers = leaderboardData.slice(0, 100);

                    leaderboardBody.innerHTML = '';
                    emptyState.classList.add('hidden');
                    
                    let rank = 1;
                    let userRank = null;

                    topPlayers.forEach((data) => {
                        const isCurrentUser = currentUser && data.id === currentUser.uid;
                        
                        if (isCurrentUser) {
                            userRank = rank;
                            showUserRankCard(rank, data);
                        }

                        const row = createLeaderboardRow(rank, data, isCurrentUser);
                        leaderboardBody.appendChild(row);
                        rank++;
                    });

                    if (currentUser && !userRank) {
                        document.getElementById('yourRankCard').classList.add('hidden');
                    }
                })
                .catch((error) => {
                    console.error('Error loading leaderboard:', error);
                    leaderboardBody.innerHTML = '<div class="error">Error loading leaderboard. Please try again.</div>';
                });
        }

        function createLeaderboardRow(rank, data, isCurrentUser) {
            const row = document.createElement('div');
            row.className = 'table-row' + (isCurrentUser ? ' current-user' : '');
            
            // Rank with medal for top 3
            let rankDisplay = rank;
            if (rank === 1) rankDisplay = 'ü•á';
            else if (rank === 2) rankDisplay = 'ü•à';
            else if (rank === 3) rankDisplay = 'ü•â';
            else rankDisplay = `#${rank}`;

            // Display name
            const displayName = data.displayName || data.userEmail.split('@')[0];

            row.innerHTML = `
                <div class="col-rank rank-${rank <= 3 ? 'medal' : 'number'}">${rankDisplay}</div>
                <div class="col-user">
                    <div class="user-info">
                        <div class="user-avatar">${displayName.charAt(0).toUpperCase()}</div>
                        <div class="user-details">
                            <div class="user-name">${displayName}${isCurrentUser ? ' <span class="you-badge">You</span>' : ''}</div>
                            <div class="user-meta">Joined ${formatDate(data.joinedDate)}</div>
                        </div>
                    </div>
                </div>
                <div class="col-score">
                    <div class="score-badge">${data.averageScore}%</div>
                </div>
                <div class="col-quizzes">${data.quizzesTaken}</div>
                <div class="col-total">${data.totalScore} pts</div>
            `;

            return row;
        }

        function showUserRankCard(rank, data) {
            const rankCard = document.getElementById('yourRankCard');
            document.getElementById('yourRank').textContent = rank;
            document.getElementById('yourAverage').textContent = data.averageScore + '%';
            document.getElementById('yourQuizzes').textContent = data.quizzesTaken;
            document.getElementById('yourTotal').textContent = data.totalScore + ' pts';
            rankCard.classList.remove('hidden');
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Recently';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
            return `${Math.floor(diffDays / 365)} years ago`;
        }

        function filterLeaderboard(filter) {
            currentFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // For now, just reload all data
            // In a production app, you'd filter by date ranges
            loadLeaderboard();
        }
    </script>
</body>
</html>

